<!DOCTYPE html>
<html><head><meta content="IE=edge" http-equiv="X-UA-Compatible"><meta charset="UTF-8"><meta content="no-cache" http-equiv="Pragma"><meta content="no-cache" http-equiv="Cache-Control"><title>vnctst-audio4 demo</title><link href="css/default.css?1494566941280" rel="stylesheet" type="text/css"><style type="text/css">button {font-family:monospace; font-size: 1.2em; padding:0.1em; margin:0.2em}
code {padding:0.5em; margin:0.5em}</style></head><body onload="vnctst.audio4.demo.bootstrap()"><div id="floating-header"><button onclick="vnctst.audio4.demo.jsmode(false)">cljs表記</button><button onclick="vnctst.audio4.demo.jsmode(true)">js表記</button></div><div id="github-ribbon"><a href="https://github.com/ayamada/vnctst-audio4" target="_blank"><img alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" src="https://camo.githubusercontent.com/365986a132ccd6a44c23a9169022c0b5c890c387/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f7265645f6161303030302e706e67" style="position: absolute; top: 0; right: 0; border: 0; z-index: 10000"></a></div><div id="main-content"><h1>vnctst-audio4 demo</h1><p><a href="https://github.com/ayamada/vnctst-audio4" target="_blank">(vnctst-audio4 github repos)</a></p><div id="message">Loading ...</div><div id="main" style="display: none"><div id="version">Version:</div><hr><div><span>この環境の端末フラグ：</span><code id="terminal-flags">(terminal-flags)</code><br><span>使用デバイス名：</span><code id="device-name">(device-name)</code><br><span>事前設定された設定項目：</span><code id="config-info">(config-info)</code><br><span>事前ロードされた音源ファイル：</span><code id="preload-info">(preload-info)</code></div><hr><div><h2>目次</h2><ul><li><a href="#前書き">前書き</a></li><li><a href="#前準備">前準備</a></li><li><a href="#基本操作">基本操作</a></li><li><a href="#設定項目">設定項目</a></li><li><a href="#高度な操作">高度な操作</a></li><li><a href="#補助機能">補助機能</a></li><li><a href="#ファイル一覧の取得">ファイル一覧の取得</a></li><li><a href="#必要知識">必要知識</a></li><li><a href="#FAQ">FAQ</a></li></ul></div><div><div><div><a name="前書き"> </a></div><br><br><h2><a class="folding-label" href="#" id="h-introduction">前書き</a></h2></div><ul id="introduction"><li>これは、ゲーム向けの音響ファイル再生ライブラリである「vnctst-audio4」のオンラインデモです。</li><li>vnctst-audio4についての概要は<a href="https://github.com/ayamada/vnctst-audio4" target="_blank">vnctst-audio4のgithubリポジトリ</a>を参照してください。</li><li>vnctst-audio4には「cljs版」と「js版」があります。サンプルコードの表記を変更したい場合は上の方にあるボタンを押してください。</li><li>サンプルボタンに書いてある以外の操作も可能です。ブラウザのデバッグコンソールを開き、サンプルボタンの表記を参考にjs式を入力してください。</li><li>このデモでは、ページのロード時に<code>debug?</code>フラグ(詳細は「設定項目」を参照)を有効化している為、再生や停止等の操作を行うとデバッグコンソールにログが表示されます。これを確認したい場合もデバッグコンソールを開いておくとよいでしょう。</li></ul></div><hr><div><div><div><a name="前準備"> </a></div><br><br><h2><a class="folding-label" href="#" id="h-preparation">前準備</a></h2></div><div id="preparation"><p>実運用時に当ライブラリを利用する前準備です。cljs版とjs版とで内容が違います</p><dl><dt>cljs版</dt><dd><ol><li><code>project.clj</code>の<code>:dependencies</code>に<code>[jp.ne.tir/vnctst-audio4 "0.2.0"]</code>を追加<br>(<a href="https://clojars.org/jp.ne.tir/vnctst-audio4" ref="noopener noreferrer" target="_blank">stable releaseの最新版はclojars</a>で確認)</li><li>利用したい<code>ns</code>内にて<code>(:require [vnctst.audio4 :as va4])</code>のような感じでrequireする</li></ol></dd><dt>js版</dt><dd><p>以下のどちらか好きな方を選ぶ</p><ul><li><code>vnctst-audio4.js</code>ファイルを<a href="https://github.com/ayamada/vnctst-audio4/releases" ref="noopener noreferrer" target="_blank">https://github.com/ayamada/vnctst-audio4/releases</a>から取ってきて配置し、html内に<code>&lt;script src=&quot;vnctst-audio4.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;</code>タグを入れて読み込む</li><li><a href="https://www.npmjs.com/" ref="noopener noreferrer" target="_blank">npm</a>に<code><a href="https://www.npmjs.com/package/vnctst-audio4" ref="noopener noreferrer" target="_blank">vnctst-audio4</a></code>の名前で登録しているので、自分の使っているパッケージマネージャの流儀で適切に取り込む</li></ul></dd></dl></div></div><hr><div><div><div><a name="基本操作"> </a></div><br><br><h2><span>基本操作</span></h2></div><p>このセクションで紹介している機能だけでも大体なんとかなります</p><h3>BGMを鳴らす</h3><dl><dt><button id="bgm-va32"> </button></dt><dd id="bgm-va32-desc"><div><span><code>"bgm/va32.ogg"</code>もしくは<code>"bgm/va32.mp3"</code>もしくは<code>"bgm/va32.m4a"</code></span>をループBGMとして再生する。</div><div>この引数は<code>"bgm/va32.ogg"</code>のように拡張子を普通に付けて指定してもよいのだが、そうすると当然、ogg再生のできないブラウザでは音が出ない事になる。</div><div>そこで<code>"bgm/va32.*"</code>形式で指定する事で、oggが再生可能ならoggを、そうでなければmp3やm4aを再生する事ができる。ただし、もちろん各拡張子のファイルを予め設置しておく必要がある(ogg/mp3/m4aの三種類全てを設置する必要はなく、mp3かm4aのどちらかは省略できる。当ライブラリではm4aを省略してoggとmp3の二つだけ設置しておくのを推奨)。</div><div>引数は<code>"http://..."</code>のようなurlも指定可能だが、その場合は<a href="https://www.google.com/search?nfpr=1&amp;q=CORS" ref="noopener noreferrer" target="_blank">CORS</a>の設定が必要になる場合がある事に注意。</div><div>「指定した拡張子の再生をブラウザがサポートしていない」「ファイルが存在しない」等の理由で再生できなかった場合は何も行われない(例外も投げられない。ただし後述の<code>debug?</code>フラグが有効ならコンソールにエラーメッセージが出力される)。</div></dd></dl><dl><dt><button id="bgm-cntr"> </button></dt><dd id="bgm-cntr-desc"><div><span><code>"bgm/cntr.ogg"</code>もしくは<code>"bgm/cntr.mp3"</code>もしくは<code>"bgm/cntr.m4a"</code></span>をループBGMとして再生する。</div><div>もし既に別のBGMが再生中の場合は、そのBGMのフェードアウトを開始し、フェードアウトが完了してから再生が開始される。</div><div>この再生/停止回りは雑に操作しても適切にフェードアウト/フェードイン処理が行われるので、この辺りの再生/停止ボタンを素早く押しまくっても問題は出ない。実運用時も雑に扱ってよい。</div></dd></dl><dl><dt><button id="bgm-oneshot-ny2017"> </button></dt><dd id="bgm-oneshot-ny2017-desc"><div><span><code>"bgm/ny2017.ogg"</code>もしくは<code>"bgm/ny2017.mp3"</code>もしくは<code>"bgm/ny2017.m4a"</code></span>を非ループBGMとして再生する。</div><div>ループしない点以外は前述のBGM再生と同じ。</div></dd></dl><dl><dt><button id="bgm-fadein-cntr"> </button></dt><dd id="bgm-fadein-cntr-desc"><div><span><code>"bgm/cntr.ogg"</code>もしくは<code>"bgm/cntr.mp3"</code>もしくは<code>"bgm/cntr.m4a"</code></span>をループBGMとして再生するが、再生開始時にフェードインがかかるようにする。</div><div>フェードイン開始する事以外は前述のBGM再生と同じ。</div></dd></dl><h3>BGMを止める</h3><dl><dt><button id="stop-bgm"> </button></dt><dd id="stop-bgm-desc"><div>現在再生中のBGMをデフォルト秒数(1秒)かけてフェード終了させる。</div><div>再生中でない場合は何も起きない。</div><div>この「デフォルト秒数」は後述の「設定項目」から変更可能。</div></dd></dl><dl><dt><button id="stop-bgm-3"> </button></dt><dd id="stop-bgm-3-desc"><div>現在再生中のBGMを3秒かけてフェード終了させる。</div></dd></dl><dl><dt><button id="stop-bgm-0"> </button></dt><dd id="stop-bgm-0-desc"><div>現在再生中のBGMを即座に停止させる。</div></dd></dl><h3>SEを鳴らす</h3><dl><dt><button id="se-launch"> </button></dt><dd id="se-launch-desc"><div><span><code>"se/launch.ogg"</code>もしくは<code>"se/launch.mp3"</code>もしくは<code>"se/launch.m4a"</code></span>をSEとして再生する。</div><div>SEとしての再生では、音源の多重再生が可能となる(ボタンを連打しても前の音が途切れたりしない。ただし一部の古い環境では非対応)。</div></dd></dl><dl><dt><button id="se-kick"> </button></dt><dd id="se-kick-desc"><div><span><code>"se/kick.ogg"</code>もしくは<code>"se/kick.mp3"</code>もしくは<code>"se/kick.m4a"</code></span>をSEとして再生する。</div></dd></dl><dl><dt><button id="stop-se"> </button></dt><dd id="stop-se-desc"><div>現在再生中のSE全てをデフォルト秒数(0秒)かけてフェード終了させる(0秒の時は即座に終了する)。</div><div>再生中でない場合は何も起きない。</div><div>この「デフォルト秒数」は後述の「設定項目」から変更可能。</div></dd></dl><dl><dt><button id="stop-se-05"> </button></dt><dd id="stop-se-05-desc"><div>現在再生中のSE全てを0.5秒かけてフェード終了させる。</div></dd></dl></div><hr><div><div><div><a name="設定項目"> </a></div><br><br><h2><span>設定項目</span></h2></div><p>項目は多いですが、実際にいじる必要があるのは音量設定とデバッグ出力ぐらいです</p><h3>現在の設定項目の値を取得する</h3><dl><dt><button id="config-volume-master"> </button></dt><dd id="config-volume-master-desc"><div>各種の設定値を取得する。</div><div>このボタンで指定している<code>volume-master</code>は「マスター音量」の現在値(詳細については次の「音量設定」の項目を参照)。</div><div>引数を変更する事で様々な設定値の取得が行えるが、項目数が多いので以下ではボタン化を省略している。確認したい場合は実際にコンソールから実行してみるとよい。</div></dd></dl><h3>音量設定</h3><dl><dt><button id="set-config-volume-master-100"> </button></dt></dl><dl><dt><button id="set-config-volume-master-25"> </button></dt><dd id="set-config-volume-master-25-desc"><div>マスター音量を設定する(音量値は0.0～1.0の範囲、初期値は0.6)。</div><div>マスター音量はBGMとSEの両方に影響する。</div></dd></dl><dl><dt><button id="set-config-volume-bgm-100"> </button></dt></dl><dl><dt><button id="set-config-volume-bgm-25"> </button></dt><dd id="set-config-volume-bgm-25-desc"><div>BGM音量を設定する(音量値は0.0～1.0の範囲、初期値は0.6)。</div><div>実際のBGMの再生音量は、この項目とマスター音量から決定される。</div><div>初期状態ではマスター音量0.6(60%)かつBGM音量0.6(60%)なので、実際のBGMの再生音量は0.36(36%)相当となる。</div><div>このデフォルト音量では小さすぎると思うなら、もっと大き目の値を設定するとよい。</div></dd></dl><dl><dt><button id="set-config-volume-se-100"> </button></dt></dl><dl><dt><button id="set-config-volume-se-25"> </button></dt><dd id="set-config-volume-se-25-desc"><div>SE音量を設定する(音量値は0.0～1.0の範囲、初期値は0.6)。</div><div>詳細は上のBGM音量の解説文と大体同じ。</div></dd></dl><h3>デバッグ出力</h3><dl><dt><button id="set-config-debug?-false"> </button></dt></dl><dl><dt><button id="set-config-debug?-true"> </button></dt><dd id="set-config-debug?-true-desc"><div>デバッグログをコンソールへ出力したい場合はtrueを設定する(初期値はfalse、ただしこのデモでは最初からtrueにしてある)。</div><div>このvnctst-audio4では「雑に扱っても問題が起こらない」事を方針としているので、ファイルのロードに失敗したりしていても再生時に例外は投げられない。単に何も再生されないだけとなる。しかしこれでは開発時に不便な為、この設定をtrueにする事で、エラー等が起こった際に、その内容をコンソールへと出力するようにできる。</div></dd></dl><dl><dt><button id="set-config-debug-verbose?-false"> </button></dt></dl><dl><dt><button id="set-config-debug-verbose?-true"> </button></dt><dd id="set-config-debug-verbose?-true-desc"><div>些細なデバッグログもコンソールへ出力したい場合はtrueを設定する(初期値はfalse、ただしこのデモでは最初からtrueにしてある)。</div><div>この設定は前述の<code>debug?</code>が有効な時にしか意味を持たない。</div><div>これを有効にする事で、前述のエラー以外に、「このBGMの再生が開始された」「このSEの再生が停止された」といった、些細な情報までコンソールに出力されるようになる。しかしほとんどの場合は邪魔にしかならないので、開発時であっても普段はfalseにしておき、再生/停止タイミング等をきちんと調べたい時のみtrueにするとよい。</div></dd></dl><h3>あまり使われない項目</h3><p>ここは読み飛ばしても問題ありません</p><dl><dt><button id="set-config-default-bgm-fade-sec-0"> </button></dt></dl><dl><dt><button id="set-config-default-bgm-fade-sec-05"> </button></dt><dd id="set-config-default-bgm-fade-sec-05-desc"><div>デフォルトのBGMフェード秒数を設定する(初期値は1)。0を設定するとフェードなしで即座に停止するようになる。</div></dd></dl><dl><dt><button id="set-config-default-se-fade-sec-0"> </button></dt></dl><dl><dt><button id="set-config-default-se-fade-sec-05"> </button></dt><dd id="set-config-default-se-fade-sec-05-desc"><div>デフォルトのSEフェード秒数を設定する(初期値は0)。0を設定するとフェードなしで即座に停止するようになる。</div></dd></dl><dl><dt><button id="set-config-dont-stop-on-background?-false"> </button></dt></dl><dl><dt><button id="set-config-dont-stop-on-background?-true"> </button></dt><dd id="set-config-dont-stop-on-background?-true-desc"><div>vnctst-audio4は、ブラウザのタブをバックグラウンドにした際にBGMを自動的に一時停止する機能を持っている(非対応ブラウザあり。また既に再生中のSEは停止されず、新たに再生されようとしたSEのみ無音化される)。</div><div>この項目にtrueを設定する事で、その機能を無効化できる(初期値はfalse)。</div></dd></dl><dl><dt><button id="set-config-se-chattering-sec-0"> </button></dt></dl><dl><dt><button id="set-config-se-chattering-sec-05"> </button></dt><dd id="set-config-se-chattering-sec-05-desc"><div>同一SE連打防止機能の閾値(秒)を設定する(初期値は0.05)。</div><div>0を設定すると無効化できる。</div><div>ゲームでは同じSEが特定タイミングで複数同時に発生する事がよくあるが、何も考えずにこれを行うと音が重なって音量の増幅が起こり、爆音や音割れの原因となってしまう(例えば、「艦これ」での爆撃シーンや雷撃シーンなどで顕著)。vnctst-audio4ではこの問題を防ぐ為に、この設定秒数以内での同一SEの再生は一つだけになるように内部で制限している。</div></dd></dl><dl><dt><button id="set-config-autoext-list-a"> </button></dt></dl><dl><dt><button id="set-config-autoext-list-b"> </button></dt><dd id="set-config-autoext-list-b-desc"><div>「<code>"filename.*"</code>」指定による拡張子自動選択機能(autoext)の拡張子の候補リストを設定する。</div><div>autoext指定した音源ファイルのロード時には、このリストの順でトライされる(ブラウザが対応していない拡張子はスキップされる)。</div><div>なお ogg, mp3, m4a 以外の拡張子を指定する際には、上記のwavのように、一緒にmime-typeも指定する必要があるので注意。</div><div>初期値は<code>["ogg" "mp3" "m4a"]</code>。</div><div>この値を変更した場合は内部状態をリセットする必要がある為、全ての再生中音源は停止され、また全てのロード済音源もアンロードされる(ロード/アンロードについては後述)。</div></dd></dl><dl><dt><button id="set-config-disable-mobile?-false"> </button></dt></dl><dl><dt><button id="set-config-disable-mobile?-true"> </button></dt><dd id="set-config-disable-mobile?-true-desc"><div>trueを設定する事で、モバイル環境での音源再生の一切を禁止する(初期値はfalse)。</div><div>非モバイル環境では何も起こらない。</div></dd></dl><dl><dt><button id="set-config-disable-webaudio?-false"> </button></dt></dl><dl><dt><button id="set-config-disable-webaudio?-true"> </button></dt><dd id="set-config-disable-webaudio?-true-desc"><div>trueを設定する事で、WebAudioによる音源再生を禁止する(初期値はfalse)。</div><div>初期状態では、WebAudioが利用可能ならWebAudioを使い、そうでなければHtmlAudioが利用可能ならHtmlAudioを使い、どちらも使えなければ再生は無効化される、という優先順位になっている。</div><div>通常はこのままで適切に機能するが、「HtmlAudioでの動作確認を取りたい」等の時はこの設定項目を有効にするとよい。</div><div>この値を変更した場合は内部状態をリセットする必要がある為、全ての再生中音源は停止され、また全てのロード済音源もアンロードされる。</div></dd></dl><dl><dt><button id="set-config-disable-htmlaudio?-false"> </button></dt></dl><dl><dt><button id="set-config-disable-htmlaudio?-true"> </button></dt><dd id="set-config-disable-htmlaudio?-true-desc"><div>trueを設定する事で、HtmlAudioによる音源再生を禁止する(初期値はfalse)。</div><div>概要については上の<code>disable-webaudio?</code>の項目を参照。</div><div>この値を変更した場合は内部状態をリセットする必要がある為、全ての再生中音源は停止され、また全てのロード済音源もアンロードされる。</div></dd></dl><dl><dt><button id="set-config-additional-query-string"> </button></dt><dd id="set-config-additional-query-string-desc"><div>ここにキャッシュ防止用の文字列を設定する事で、音源ロード時のurlの末尾に<code>QUERY_STRING</code>として、その文字列が設定される(初期値はnil)。</div></dd></dl></div><hr><div><div><div><a name="高度な操作"> </a></div><br><br><h2><span>高度な操作</span></h2></div><h3>プリロード / アンロード</h3><dl><dt><button id="load-noise"> </button></dt><dd id="load-noise-desc"><div>BGMやSEの音響ファイルの初回再生時は、実は内部でファイルのロードを行いそれが完了してから再生している。その為、初回再生時のみ実際に再生されるまでタイムラグがある(ファイルサイズが小さかったりブラウザキャッシュがなされていれば目立たないが)。このタイムラグをなくすには、再生するよりずっと前の段階でロードを行っておけばよい。</div><div>この関数はそのロードをバックグラウンドで行わせる。</div><div>一度に大量のファイルのロード要求が来た場合でも、同時にロードを実行せずに一つずつ順番にロードを実行していく為、大量のhttpコネクションを消費してしまう事はない。雑にロード要求を投げてよい。</div><div>指定したファイルが既にロード中だったりロードが完了している場合は何も行われない。</div></dd></dl><dl><dt><button id="loaded?"> </button></dt><dd id="loaded?-desc"><div>音響ファイルのロードはバックグラウンドで非同期に実行される。この関数は、そのロード処理が正常終了/異常終了のどちらにせよ完了しているかどうかを真偽値で返す。</div><div>ローディング画面等では、定期的にこの関数を呼んでロードが完了したかを確認するとよい。</div></dd></dl><dl><dt><button id="error?"> </button></dt><dd id="error?-desc"><div>前述の<code>loaded?</code>/<code>isLoaded</code>ではロードの完了は分かるものの、正常にロードできたかまでは分からない。</div><div>ロード時にエラーが起こったかどうかを調べたい時は、真偽値としてそれを返すこの関数が使える。</div><div>なお、エラーの起こったファイルを再生しようとしても何も起こらないので、雑に扱っても問題ない(もちろん、<code>debug?</code>フラグを有効にしていればコンソールへのエラー通知は行われる)。</div><div>ただし上記について例外があり、別のBGMの再生中のみ、再生中BGMのフェードアウト終了が開始される仕様としている。これはBGM変更の状況では、エラーの起こったファイルの再生が無視されて元のBGMが鳴り続けるよりも、元のBGMは普通に終わらせておいた方がまだマシであると考え、この仕様とした。</div></dd></dl><dl><dt><button id="unload-noise"> </button></dt><dd id="unload-noise-desc"><div>音響ファイルの数が非常に多い場合やサーバで動的に生成した音響ファイルを扱う場合、ロード済の音源が多くなりメモリを圧迫してしまう事がある。その場合はこの関数を使い、再生しない音源をアンロードするとよい。</div><div>もしアンロード時にまだその音響ファイルが再生中だった場合、その再生は強制停止される。</div><div>アンロードを行った音響ファイルを再度再生しようとした場合は内部でファイルのロードが実行し直されるので、効率は悪いものの再生自体に支障が出る事はない。</div><div>アンロード後は、前述の<code>loaded?</code>/<code>isLoaded</code>が、falseを返すように戻る。</div><div>そもそもロードしていない音響ファイルをアンロードしようとしても何も起こらない(エラーも投げられない)ので、雑に実行しても問題ない。</div><div>ロード最中の音響ファイルのアンロードも問題なく行える。</div></dd></dl><dl><dt><button id="unload-all"> </button></dt><dd id="unload-all-desc"><div>ロード済の全ての音響ファイルをアンロードする。</div></dd></dl><h3>BGMの再生オプション</h3><dl><dt><button id="bgm-option-a"> </button></dt><dd id="bgm-option-a-desc"><div><span><code>"bgm/va32.ogg"</code>もしくは<code>"bgm/va32.mp3"</code>もしくは<code>"bgm/va32.m4a"</code></span>をBGMとして再生する。</div><div><code>volume</code>は個別の音量。通常 0.0 ～ 1.0 の数値。指定しない場合は 1.0 が指定された事になる。volumeに1.0以上の数値を指定する事も可能だが、マスターボリュームとBGMボリュームの設定によっては効果が出ない(「volume * マスターボリューム * BGMボリューム」の値を1.0以上にする事はできない為)。</div><div><code>pitch</code>は再生レート。 0.1 ～ 10.0 の数値。指定しない場合は 1.0 が指定された事になる。この数値が1.0より小さいと再生速度と音程が低下し、1.0より大きいと再生速度と音程が上昇する。ブラウザによっては常に1.0固定となる為、この数値に依存するような処理は避けた方が無難。</div><div><code>pan</code>はステレオでの左右への寄りの値。 -1.0 ～ 1.0 の数値。-1.0が最も左寄り、0なら中央、1.0が最も右寄りに再生される。指定しない場合は 0 が指定された事になる。ブラウザによっては常に中央固定になる為、この数値に依存するような処理は避けた方が無難。</div></dd></dl><dl><dt><button id="bgm-option-b"> </button></dt><dd id="bgm-option-b-desc"><div><span><code>"bgm/va32.ogg"</code>もしくは<code>"bgm/va32.mp3"</code>もしくは<code>"bgm/va32.m4a"</code></span>をBGMとして再生する。</div><div>各オプションの詳細については前述の説明を参照。</div><div>cljs版では、追加の引数は一つのmapで指定してもよいし、複数のkey-value値として指定してもよい(js版ではObject形式での指定のみ可能)。</div></dd></dl><dl><dt><button id="bgm-option-c"> </button></dt><dd id="bgm-option-c-desc"><div><span><code>"bgm/va32.ogg"</code>もしくは<code>"bgm/va32.mp3"</code>もしくは<code>"bgm/va32.m4a"</code></span>をBGMとして再生する。</div><div>オプションの詳細については前述の説明を参照。</div></dd></dl><dl><dt><button id="bgm-option-d"> </button></dt><dd id="bgm-option-d-desc"><div><span><code>"bgm/ny2017.ogg"</code>もしくは<code>"bgm/ny2017.mp3"</code>もしくは<code>"bgm/ny2017.m4a"</code></span>をBGMとして再生する。</div><div><code>oneshot?</code>に真値を指定する事により、非ループ再生となる。前述の<code>bgm-oneshot!</code>/<code>bgmOneshot</code>は、内部でこのパラメータを設定している。</div><div><code>fadein</code>にフェードイン秒数を指定する事により、再生開始時にフェードインが適用されるようになる。前述の<code>bgm-fadein!</code>/<code>bgmFadein</code>は、内部でこのパラメータを設定している。</div></dd></dl><dl><dt><button id="bgm-noise-ch"> </button></dt><dd id="bgm-noise-ch-desc"><div><span><code>"bgm/noise.ogg"</code>もしくは<code>"bgm/noise.mp3"</code>もしくは<code>"bgm/noise.m4a"</code></span>を「<code>background-sound</code>」という名前のBGM再生チャンネルにて、ループBGMとして再生する。</div><div>BGM再生チャンネルは必要な数だけ作成でき、違うBGM再生チャンネルは同時に再生される。これは「BGMと同時に雨の音などの環境音を再生したい」ような用途に利用できる。</div><div>BGM再生チャンネル名には、cljs版では任意のキーワードが、js版では任意の文字列が指定できる。</div><div>BGM再生チャンネル名が省略された場合はデフォルト値として「<code>BGM</code>」が指定されたものとして扱われる。</div><div>BGM再生チャンネル名以外にも、前述の他のオプションも同時に指定可能。</div></dd></dl><dl><dt><button id="stop-bgm-ch-a"> </button></dt><dd id="stop-bgm-ch-a-desc"><div>第二引数で指定した「BGM再生チャンネル名」で再生中のBGMだけを、第一引数で指定したフェード秒数かけて終了する。</div><div>第一引数に nil / null を指定した場合は、設定されたデフォルト値がフェード秒数として適用される(デフォルト値の詳細については「設定項目」セクションを参照)。</div><div>第二引数省略時は全てのBGMチャンネルに対して停止処理が行われる。</div><div>この例では「<code>background-sound</code>」だけが停止される。</div></dd></dl><dl><dt><button id="stop-bgm-ch-b"> </button></dt><dd id="stop-bgm-ch-b-desc"><div>第二引数で指定した「BGM再生チャンネルID」で再生中のBGMだけを、第一引数で指定したフェード秒数かけて終了する。</div><div>この例では「<code>BGM</code>」、つまりチャンネル無指定でのBGM再生だけが停止される。</div></dd></dl><h3>SEの再生オプション</h3><dl><dt><button id="se-option-a"> </button></dt><dd id="se-option-a-desc"><div><span><code>"se/launch.ogg"</code>もしくは<code>"se/launch.mp3"</code>もしくは<code>"se/launch.m4a"</code></span>をSEとして再生する。</div><div><code>volume</code>は個別の音量。通常 0.0 ～ 1.0 の数値。指定しない場合は 1.0 が指定された事になる。volumeに1.0以上の数値を指定する事も可能だが、マスターボリュームとBGMボリュームの設定によっては効果が出ない(「volume * マスターボリューム * SEボリューム」の値を1.0以上にする事はできない為)。</div><div><code>pitch</code>は再生レート。 0.1 ～ 10.0 の数値。指定しない場合は 1.0 が指定された事になる。この数値が1.0より小さいと再生速度と音程が低下し、1.0より大きいと再生速度と音程が上昇する。ブラウザによっては常に1.0固定となる為、この数値に依存するような処理は避けた方が無難。</div><div><code>pan</code>はステレオでの左右への寄りの値。 -1.0 ～ 1.0 の数値。-1.0が最も左寄り、0なら中央、1.0が最も右寄りに再生される。指定しない場合は 0 が指定された事になる。ブラウザによっては常に中央固定になる為、この数値に依存するような処理は避けた方が無難。</div></dd></dl><dl><dt><button id="se-option-b"> </button></dt><dd id="se-option-b-desc"><div><span><code>"se/launch.ogg"</code>もしくは<code>"se/launch.mp3"</code>もしくは<code>"se/launch.m4a"</code></span>をSEとして再生する。</div><div>各オプションの詳細については前述の説明を参照。</div><div>cljs版では、追加の引数は一つのmapで指定してもよいし、複数のkey-value値として指定してもよい(js版ではObject形式での指定のみ可能)。</div></dd></dl><dl><dt><button id="se-option-c"> </button></dt><dd id="se-option-c-desc"><div><span><code>"se/launch.ogg"</code>もしくは<code>"se/launch.mp3"</code>もしくは<code>"se/launch.m4a"</code></span>をSEとして再生する。</div><div>オプションの詳細については前述の説明を参照。</div><div>SE再生関数は、返り値として「SE再生チャンネルID」を返す。これについての詳細は次の項目を参照。</div></dd></dl><dl><dt><button id="stop-se-ch"> </button></dt><dd id="stop-se-ch-desc"><div>第二引数で指定した「SE再生チャンネルID」に対応するSEだけを、第一引数で指定したフェード秒数かけて終了する。</div><div>「SE再生チャンネルID」は、SE再生関数の返り値として得られる(「SE再生チャンネルID」はこの個別の停止指定の為の存在なので、個別停止を行わないのであれば、そのまま捨てても全く問題ない)。</div><div>第二引数で指定した「SE再生チャンネルID」に対応するSEの再生が既に完了している場合は何も起きない。</div><div>第一引数に nil / null を指定した場合は、設定されたデフォルト値がフェード秒数として適用される(詳細については既出の「設定項目」内「音量設定」の項目を参照)。</div><div>第二引数省略時は全てのSEに対して停止処理が行われる。</div><div>この機能は、登場キャラクタがボイスを発生するような内容のゲームでの利用を想定している。</div></dd></dl><dl><dt><button id="alarm-kick"> </button></dt><dd id="alarm-kick-desc"><div><span><code>"se/kick.ogg"</code>もしくは<code>"se/kick.mp3"</code>もしくは<code>"se/kick.m4a"</code></span>をSEとして再生する。</div><div>ただしバックグラウンドタブであっても強制的に再生が行われる(通常はバックグラウンドタブ時はSEの再生が行われない)。</div><div>通常のSE再生と同様に、追加の引数を取る事もできる(詳細は上記参照)。</div></dd></dl><h3>その他</h3><p>旧版であるvnctst-audio3由来のインターフェースです</p><dl><dt><button id="me-launch"> </button></dt><dd id="me-launch-desc"><div><span><code>"se/launch.ogg"</code>もしくは<code>"se/launch.mp3"</code>もしくは<code>"se/launch.m4a"</code></span>を非ループBGMとして再生する。</div><div>前述の<code>bgm-oneshot!</code>/<code>bgmOneshot</code>と全く同じ。</div><div>分かりづらいのでobsoletedとする。</div></dd></dl><dl><dt><button id="bgs-noise"> </button></dt><dd id="bgs-noise-desc"><div><span><code>"bgm/noise.ogg"</code>もしくは<code>"bgm/noise.mp3"</code>もしくは<code>"bgm/noise.m4a"</code></span>を「<code>BGS</code>」という名前のBGM再生チャンネルで再生する。</div><div>分かりづらいのでobsoletedとする。</div></dd></dl><dl><dt><button id="se-kick-keyword"> </button></dt><dd id="se-kick-keyword-desc"><div>キーワードでpathを指定する機能はcljs版のみ対応しており、js版では対応していない。</div><div>引数にキーワードを指定した場合、<code>:foo</code>なら<code>"foo.*"</code>へと、<code>:bar/baz</code>なら<code>"bar/baz.*"</code>へと、自動的に展開されて扱われる。</div><div>キーワード構文の仕様上、二段以上深いディレクトリ内にあるファイルをキーワード構文で指定する事はできない。この制約により、利用できる場面はかなり限定される。</div></dd></dl></div><hr><div><div><div><a name="補助機能"> </a></div><br><br><h2><span>補助機能</span></h2></div><p>便利関数類です</p><dl><dt><button id="version-js"> </button></dt><dd id="version-js-desc"><div>vnctst-audio4のライブラリとしてのバージョン文字列。js版のみ提供。</div></dd></dl><dl><dt><button id="can-play-ogg"> </button></dt><dd id="can-play-ogg-desc"><div>oggが再生可能なら真値を返す。</div></dd></dl><dl><dt><button id="can-play-mp3"> </button></dt><dd id="can-play-mp3-desc"><div>mp3が再生可能なら真値を返す。</div></dd></dl><dl><dt><button id="can-play-m4a"> </button></dt><dd id="can-play-m4a-desc"><div>m4aが再生可能なら真値を返す。</div></dd></dl><dl><dt><button id="can-play"> </button></dt><dd id="can-play-desc"><div>引数として渡したmime-typeが再生可能なら真値を返す。</div></dd></dl><dl><dt><button id="terminal-type"> </button></dt><dd id="terminal-type-desc"><div>この環境が引数として渡した端末タイプなら真値を返す。</div><div>端末タイプは<code>tablet</code> <code>mobile</code> <code>android</code> <code>ios</code> <code>chrome</code> <code>firefox</code>が指定可能。ただしこれは User-Agent による判定の為、誤判定する場合もある事に注意。</div><div>これはjs版では関数だが、cljs版では単なるsetでありset向けの各種の操作を適用する事ができる。</div></dd></dl><dl><dt><button id="float-&gt;percent"> </button></dt><dd id="float-&gt;percent-desc"><div>各ボリューム設定は0.0～1.0の小数値で指定するが、これを0～100のパーセント値へと変換する単純なユーティリティ関数。</div></dd></dl><dl><dt><button id="percent-&gt;float"> </button></dt><dd id="percent-&gt;float-desc"><div>上記 float->percent / floatToPercent の逆変換を行うユーティリティ。</div></dd></dl><dl><dt><button id="current-device-name"> </button></dt><dd id="current-device-name-desc"><div>当ライブラリ内部での再生デバイス名を文字列として返す。</div><div>具体的に返される値は以下のいずれか。</div><ul><li><code>web-audio</code> : WebAudio</li><li><code>html-audio-multi</code> : HtmlAudio。SE多重再生サポートあり</li><li><code>html-audio-single</code> : HtmlAudio。SE多重再生サポートなし</li><li><code>dumb</code> : 無音</li></ul></dd></dl><dl><dt><button id="make-play-se-periodically"> </button></dt><dd id="make-play-se-periodically-desc"><div>エンジン音、プロペラ回転音、機関銃音のような「動作中は定期的に再生する」タイプのSEの為に、「動作中は定期的に実行するが、実行が集中しないように、指定したsec間隔以内での再生を抑制する」関数を生成する高階関数。</div><div>最初の引数として「抑制する秒数」を渡す。</div><div>これは「エンジンが加速中の間は毎フレーム鳴らす(再生関数を実行する)が、(ユーザの入力次第で)加速が停止したら鳴らさない」ような状況で利用するとよい(もしそうではなく、終了時に明示的に停止させる方が望ましい場合は、専用チャンネルでループBGMとして再生させた方がより良い)。</div><div>再生するSEのパラメータは、高階関数のオプショナル引数として渡してもよいし、生成された関数の方の引数として渡してもよい(生成された方に何も渡されなかった場合は、高階関数のオプショナル引数が適用される)。</div><div>再生されたか抑制されたかは、返り値として nil / null が返るか、SEチャンネルID値が返るかで判定できる。</div></dd></dl><dl><dt><button id="make-play-se-personally"> </button></dt><dd id="make-play-se-personally-desc"><div>一人のキャラが複数のボイスを再生するような場合は、同時再生を一つだけに抑制したいケースがほとんど。これを実現する関数を、再生元(この例ではキャラ)ごとに生成する高階関数。</div><div>具体的には、あるボイスを再生中に別のボイスの再生を行おうとしたタイミングで、先に再生していたボイスが自動的に停止させられるようになる。</div><div>高階関数の引数として、自動停止時のフェード秒数が指定可能(無指定の場合は通常のSEのデフォルトフェード秒数が適用される)。</div><div>生成された関数の引数には、通常のSE再生用の引数を渡す。</div></dd></dl></div><hr><div><div><div><a name="ファイル一覧の取得"> </a></div><br><br><h2><span>ファイル一覧の取得</span></h2></div><p>これはcljs版専用の機能です。js版では利用できません</p><dl><dt><strong>これは何？</strong></dt><dd>実際のゲームで利用する場合、「最初のローディング画面で音源ファイルのプリロードを行う」みたいな事がよくある。しかし、いちいちゲーム中で使っている音源ファイル全てを手で列挙していくのはとても面倒なので、例えば<code>"se/"</code>ディレクトリを指定したら<code>["se/launch.*" "se/kick.*"]</code>のような形式でファイルの一覧を取得できる機能を用意した。</dd><dt><strong>重要な注意点</strong></dt><dd>ブラウザ上で「ファイルの一覧を取得」するような事は通常できない為、この機能は「マクロの展開フェーズにローカルファイルの一覧を取得」する事によって実現している。その為「ローカルのpathとブラウザ上でのpathの二つを引数に指定する必要がある」「引数は即値の文字列でないといけない」「マクロ展開後に音源ファイルを追加しても、再コンパイルするまでは認識されない」という制約がある。</dd></dl><dl><dt><code>(ns foo.bar (:require [vnctst.audio4.prefetch :include-macros true]))</code></dt><dd>このファイル一覧取得機能は<code>vnctst.audio4.prefetch</code>に入っているので、別途requireしておく。<br>ここには書いてないが<code>:as</code>を指定して短い別名を付けておくとよい。<br>この機能はマクロで実装されている為<code>:include-macros true</code>を必ず付ける事。</dd><dt><code>(vnctst.audio4.prefetch/pathlist-from-directory "resources/public/se/" "se/")</code></dt><dd>第一引数は、ファイル一覧を取得するローカルディレクトリ。マクロの制約により、これは即値の文字列でなくてはならない。変数や式を指定した場合はコンパイルエラーが投げられる。末尾のスラッシュはあってもなくてもよい。<br>第二引数は、httpサーバ上でのディレクトリ。第一引数に対応するものを指定する事。末尾のスラッシュはあってもなくてもよい。<br>この式はコンパイルフェーズに評価され、<code>["se/launch.*" "se/kick.*"]</code>のようなvecとしてソースに埋め込まれる。このvecを適当な変数にdefしておき、早いタイミングでdoseq等を使って<code>load!</code>にかけておくとよい。<br>なお、第一引数で指定したローカルディレクトリ内には音響ファイルだけを入れておく事(そうしないと音響ファイル以外もこのリストに追加されてしまう為)。</dd><dt><code>(vnctst.audio4.prefetch/pathlist-from-directory "resources/public/se/" "se/" true)</code></dt><dd>第三引数に即値の真値を指定すると、autoext変換が行われなくなる。<br>具体的には、上ではマクロの展開結果が<code>["se/launch.*" "se/kick.*"]</code>のようになるが、こちらでは<code>["se/launch.ogg" "se/launch.mp3" "se/kick.ogg" "se/kick.mp3"]</code>のようになる。autoext指定をしない運用をする場合はこちらを使う必要がある。</dd></dl></div><hr><div><div><div><a name="必要知識"> </a></div><br><br><h2><span>必要知識</span></h2></div><p>html5上の音響システム固有の前提知識。ライブラリレベルでは吸収できないバッドノウハウ類です</p><h4>「この拡張子なら全ブラウザで再生できる」という万能ファイル形式は存在しない</h4><ul><li>なので、なるべく多くのブラウザでの再生をサポートしたい場合複数種類の拡張子のファイルを用意する必要があります。</li><li>再生回りでのトラブルの少なさは「ogg、mp3、m4a、他」の順なので、この優先順位で二つほど選ぶと良いでしょう(「oggとmp3をセットで配置」もしくは「oggとm4aをセットで配置」あたりが安定)。</li><li>どうしても一つに絞る場合は、「oggを採用し、ieとsafariでの再生を切り捨てる」「mp3を採用し、一部os向けfirefoxを切り捨て、一部モバイル環境で出る不具合には目をつぶる」「m4aを採用し、一部os向けfirefoxを切り捨て、一部モバイル環境で出る不具合には目をつぶる」のどれかを選択する事になります。</li><li>なお、「oggは内部コーデックが通常のvorbisのもののみ対応」「可変ビットレートでエンコードしたmp3は、一部環境で読み込みに失敗する」「m4aは内部コーデックがaacのもののみ対応」という制約もあるので、音源ファイルのエンコード時にはこの辺りにも気を付けておくとよいでしょう(特にmp3は、エンコーダのデフォルト設定で可変ビットレートが有効になっている事が多いので注意)。</li></ul><h4>無音であっても支障が出ないようにする</h4><ul><li>前述の拡張子対応をどんなにがんばっても、古いモバイル端末では、音源の一部/全部が再生されないものもあります。</li><li>またそもそも、ハード側の音量を0にした状態で使われる事もよくあります。なので、「音が出なくても利用できる」ようになっているのがベターでしょう。</li></ul><h4>違うドメインにあるファイルを再生する場合は<a href="https://www.google.com/search?nfpr=1&amp;q=CORS" ref="noopener noreferrer" target="_blank">CORS設定</a>が必要</h4><ul><li>詳細はリンクから自分で調べてください</li></ul></div><hr><div><div><div><a name="FAQ"> </a></div><br><br><h2><span>FAQ</span></h2></div><p>その他の質問など</p><h4>音が出ない</h4><ul><li><code>debug?</code>フラグを有効にして、コンソールにエラーが出ていないか確認してみよう</li><li>多くのブラウザでは、ローカルファイル(<code>file:///...</code>形式のurl)からの再生はできません。対応しているブラウザで動作確認するか、httpサーバを用意してその中に配置して動作確認しよう</li><li><a href="https://github.com/ayamada/vnctst-audio4#対応環境マトリックス" ref="noopener noreferrer" target="_blank">対応環境マトリックス</a>を確認してみよう</li></ul><h4>音が小さい</h4><ul><li>デフォルトの音量は36%相当です。オンラインデモのサンプルコードを確認して、マスターボリューム、BGMボリューム、SEボリュームを大き目に設定してみよう</li></ul><h4><code>pitch</code>の効果が出ない</h4><ul><li><code>pitch</code>と<code>pan</code>は機能しない環境があります(WebAudio非対応環境および一部のモバイル環境)。pitch指定が効かない場合でもそれなりに聴けるようにしておくとベターです</li></ul><h4>特定の環境でのみ、特定のmp3ファイルがロードエラーを起こす</h4><ul><li>ブラウザによってはmp3の特定のエンコードオプション(abr等)を解釈できずにエラーになるものがあるようです。問題の出るmp3ファイルは、abr等のオプションなしの固定ビットレートでエンコードし直すとよいでしょう。</li></ul><h4>再生環境によっては、BGMのループの際に少しだけ無音の時間がはさまる</h4><ul><li>HtmlAudioモードで動作する古いモバイル環境で、この問題が起こるようです。<br>再生環境側の問題なので、ライブラリレベルでの対応は厳しいです。</li></ul><h4>モバイル環境で、再生開始までにものすごく時間のかかる時がある</h4><ul><li>モバイル環境では「タッチイベントを実行するまでは再生できない」という仕様になっているブラウザが主流です。画面のどこかをタッチする事で再生が開始された場合、この仕様に引っかかっています。<br>モバイル向けを意識する場合は「タイトル画面は無音にする」等、この仕様を意識した作りにするとよいでしょう</li></ul><h4>いちいち<code>vnctst.audio4.js.bgm("hoge.ogg")</code>って書くのは長くて面倒</h4><ul><li>最初に<code>var va4 = vnctst.audio4.js;</code>を実行しておけば、以降は<code>va4.bgm("hoge.ogg")</code>ですみます</li></ul><h4>いちいち<code>va4.bgm("foo/bar/hoge.ogg")</code>って毎回pathを指定するのは微妙</h4><ul><li>変数やhash-mapを使いましょう。<br><br>他の音響再生ライブラリには「ロードした音源を自分で指定したキーワードに割り当て、再生したい時にはそのキーワードで指定する」ような機構を持つものが多く、またvnctst-audioの過去のバージョンでも類似の仕組みを採用していました。<br>このキーワード割り当てを行う方式は「再生する事前に必ずロードを実行して完了させておく」制約のあるシステム上では確かに有用なのですが(キーワードに割り当てられている＝事前に再生する対象であると指定された事が保証されている)、「雑に扱える」事をポリシーとするvnctst-audio4では前述の制約のない実装にできたので、結果として「いちいちキーワードに割り当てる手間」というデメリットだけが残った為、キーワード割り当て方式は廃止されました。<br>もちろんキーワード的な管理をした方がよいケースは普通に存在しますが、その場合は自分で変数やhash-mapを使って管理した方が扱いやすいでしょう</li></ul><h4>このオンラインデモのサンプルBGM/SEについて</h4><ul><li>これらのBGM/SEは当プロジェクトのメンテナであるayamadaが作成したものです。<br>これらのライセンスは<a href="http://sciencecommons.jp/cc0/about" ref="noopener noreferrer" target="_blank">CC0</a>とします</li></ul><h4>vnctstってなんて読むの</h4><ul><li>作者は頭の中で「ぶいえぬしーてぃーえすてぃー」と読んでいます。<br>これは「<a href="http://vnctst.tir.jp/" ref="noopener noreferrer" target="_blank">vnctst games</a>」というインディーズゲーム作成ブランドの名前から来ています。しかしあまりに人間には発音しづらいので、このブランド名はもっと読みやすい名前に変更したいと考えています。<br>ただし、将来にゲーム作成ブランド名を変更しても、この vnctst-audio4 の名前はこのままにする予定です。</li></ul><h4>なんかおかしい / バグ報告したい</h4><ul><li><a href="https://github.com/ayamada/vnctst-audio4/issues" ref="noopener noreferrer" target="_blank">githubリポジトリのissue</a>から可能です。日本語でokです</li></ul></div><hr><p><a href="https://github.com/ayamada/vnctst-audio4" target="_blank">(vnctst-audio4 github repos)</a></p></div></div><script src="cljs/cl.js?1494566941309" type="text/javascript"></script></body></html>